<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RAG 摄取作业</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./assets/styles.css?v=20250118" />
  </head>
  <body>
    <div class="bg-gradient"></div>
    <div class="bg-grid"></div>
    <div class="bg-noise"></div>

    <header class="topbar">
      <div class="brand">
        <div class="logo-dot"></div>
        <div class="brand-text">
          <span>RAG 中台控制台</span>
          <small>摄取作业</small>
        </div>
      </div>
      <div class="topbar-actions">
        <div class="api-status">
          <span class="status-dot" id="api-status-dot"></span>
          <span id="api-status-text">离线</span>
        </div>
        <div class="identity-status">
          <span class="role-pill super" id="role-pill">超级管理员</span>
          <span class="wallet-id" id="wallet-id-display">-</span>
        </div>
        <div class="api-input">
          <input
            id="api-base"
            type="text"
            placeholder="API 地址（可选）"
            autocomplete="off"
          />
          <button id="refresh-btn">刷新</button>
        </div>
        <button class="ghost" id="login-btn">切换账号</button>
        <button class="ghost" id="back-btn">返回</button>
      </div>
    </header>

    <div class="layout single">
      <main class="main">
        <section class="hero reveal">
          <div class="hero-copy">
            <h1>摄取作业中心。</h1>
            <p>创建与运行摄取任务，集中查看作业状态与错误信息。</p>
            <div class="hero-actions">
              <button class="primary" id="job-refresh">刷新作业</button>
              <button class="ghost" id="job-clear">清空输出</button>
            </div>
            <p class="form-hint">面向业务的数据接入工单：把业务文档变成可检索的知识。</p>
            <details class="hint-details">
              <summary>展开说明</summary>
              <p class="form-hint">
                每条作业会完成“解析 → 向量化 → 入库”，并记录执行状态与失败原因，便于追踪数据质量与责任归属。
              </p>
            </details>
          </div>
          <div class="hero-metrics">
            <div class="metric-card">
              <span class="metric-label">作业总数</span>
              <span class="metric-value" id="metric-total">0</span>
              <span class="metric-trend">当前筛选</span>
            </div>
            <div class="metric-card">
              <span class="metric-label">运行中</span>
              <span class="metric-value" id="metric-running">0</span>
              <span class="metric-trend">处理中</span>
            </div>
            <div class="metric-card">
              <span class="metric-label">失败</span>
              <span class="metric-value" id="metric-failed">0</span>
              <span class="metric-trend">需排查</span>
            </div>
          </div>
        </section>

        <section class="panel-row reveal single">
          <div class="panel">
            <div class="panel-header">
              <div>
                <h2>创建作业</h2>
                <p>选择 app + KB，并提供 MinIO URL 或内联文本。</p>
              </div>
            </div>
            <form id="job-form" class="doc-form">
              <div class="form-grid">
                <div class="form-group">
                  <label for="job-app-select">目标应用</label>
                  <select id="job-app-select"></select>
                </div>
                <div class="form-group">
                  <label for="job-kb-select">目标 KB</label>
                  <select id="job-kb-select"></select>
                </div>
                <div class="form-group">
                  <label for="job-data-wallet">业务用户钱包</label>
                  <input id="job-data-wallet" type="text" placeholder="业务用户 wallet_id（可选）" />
                  <p class="form-hint">仅 user_upload 类型会按该钱包隔离数据。</p>
                </div>
                <div class="form-group">
                  <label for="job-session-id">业务会话</label>
                  <input id="job-session-id" type="text" placeholder="session_id（可选）" />
                  <p class="form-hint">会话会绑定到私有库，用于私有数据隔离。</p>
                </div>
                <div class="form-group">
                  <label for="job-private-db-id">私有库 ID</label>
                  <input id="job-private-db-id" type="text" placeholder="private_db_id（可选）" />
                  <p class="form-hint">与 session_id 同时填写需一致。</p>
                </div>
                <div class="form-group">
                  <label for="job-source-url">MinIO URL</label>
                  <input id="job-source-url" type="text" placeholder="minio://bucket/path/file.json" />
                  <p class="form-hint" id="job-prefix"></p>
                </div>
                <div class="form-group">
                  <label for="job-file-type">文件类型</label>
                  <input id="job-file-type" type="text" placeholder="json / txt / html" />
                </div>
                <div class="form-group">
                  <label for="job-filename">内联文件名</label>
                  <input id="job-filename" type="text" placeholder="note.txt" />
                </div>
                <div class="form-group">
                  <label for="job-run-now">立即执行</label>
                  <select id="job-run-now">
                    <option value="yes">是</option>
                    <option value="no">否</option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label for="job-content">内联内容</label>
                <textarea id="job-content" rows="4" placeholder="可选：直接粘贴文本"></textarea>
              </div>
              <div class="panel nested">
                <div class="panel-header">
                  <div>
                    <h2>最近文件</h2>
                    <p>从 MinIO 选择已上传的文件。</p>
                  </div>
                  <button class="ghost" type="button" id="job-prefix-refresh">刷新</button>
                </div>
                <div class="pill-row" id="job-recent-keys"></div>
              </div>

              <div class="form-grid">
                <div class="form-group">
                  <label for="job-metadata">Metadata (JSON)</label>
                  <textarea id="job-metadata" class="text-mono" rows="3" placeholder='{"source":"upload"}'></textarea>
                </div>
                <div class="form-group">
                  <label for="job-options">Options (JSON)</label>
                  <textarea id="job-options" class="text-mono" rows="3" placeholder='{"max_chars":8000}'></textarea>
                </div>
              </div>

              <div class="form-actions">
                <button class="primary" type="submit">创建作业</button>
                <button class="ghost" type="button" id="job-reset">重置表单</button>
              </div>
              <p class="form-hint" id="job-hint"></p>
            </form>
          </div>
        </section>

        <section class="panel-row reveal single">
          <div class="panel">
            <div class="panel-header">
              <div>
                <h2>作业列表</h2>
                <p>查看作业状态并运行。</p>
              </div>
              <div class="panel-tools">
                <span class="detail-label">应用</span>
                <select id="jobs-app-select"></select>
                <span class="detail-label">业务用户钱包</span>
                <input id="jobs-data-wallet" type="text" placeholder="wallet_id（可选）" />
                <span class="detail-label">会话</span>
                <input id="jobs-session-id" type="text" placeholder="session_id（可选）" />
                <span class="detail-label">私有库</span>
                <input id="jobs-private-db-id" type="text" placeholder="private_db_id（可选）" />
                <span class="detail-label">状态</span>
                <select id="jobs-status-select">
                  <option value="">全部</option>
                  <option value="pending">pending</option>
                  <option value="running">running</option>
                  <option value="success">success</option>
                  <option value="failed">failed</option>
                </select>
                <button class="ghost" id="jobs-refresh">刷新</button>
              </div>
            </div>
            <div class="table job-table" id="jobs-table"></div>
            <p class="form-hint" id="jobs-hint"></p>
          </div>
        </section>

        <section class="panel-row reveal single">
          <div class="panel">
            <div class="panel-header">
              <div>
                <h2 id="job-output-title">作业详情</h2>
                <p>显示选中作业的返回与运行记录。</p>
              </div>
              <div class="panel-tools">
                <button class="ghost" id="job-output-copy">复制 JSON</button>
                <button class="ghost" id="job-output-clear">清空</button>
              </div>
            </div>
            <pre class="detail-log validation-output" id="job-output">尚未选择作业。</pre>
            <p class="form-hint" id="job-output-hint"></p>
          </div>
        </section>
      </main>
    </div>

    <script type="module" src="./src/ingestion_jobs.js?v=20250118"></script>
  </body>
</html>
